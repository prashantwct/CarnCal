```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carnivore Pro v11</title>
    <style>
        :root {
            --primary: #1b5e20;
            --accent: #4caf50;
            --bg: #f4f6f8;
            --card-bg: #ffffff;
            --text: #2d3436;
            --border: #dfe6e9;
            --danger: #d63031;
            --blue: #0984e3;
            --warning: #fff3cd;
            --warn-text: #856404;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; padding: 0; background: var(--bg); color: var(--text); 
            padding-bottom: 110px; font-size: 16px;
        }
        
        /* UI STYLES (Screen Only) */
        @media screen {
            header { background: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
            h1 { margin: 0; font-size: 1.2rem; font-weight: 700; }
            .subtitle { font-size: 0.75rem; opacity: 0.9; }

            .container { max-width: 800px; margin: 0 auto; padding: 15px; }
            
            .card { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); }
            .card-warn { border-left-color: #ffc107; background: #fffbf2; }
            
            .tabs-wrapper { position: sticky; top: 58px; z-index: 900; background: var(--bg); padding: 10px 0; margin: 0 -15px 15px -15px; overflow-x: auto; display: flex; gap: 10px; padding-left: 15px; }
            .tab { flex: 0 0 auto; padding: 10px 20px; border-radius: 20px; background: #e0e0e0; color: #555; font-weight: 600; font-size: 0.9rem; border: 1px solid transparent; }
            .tab.active { background: var(--primary); color: white; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
            .tab-content { display: none; animation: fadeIn 0.3s; }
            .tab-content.active { display: block; }

            .form-group { margin-bottom: 15px; }
            label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.85rem; color: #444; }
            input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; background: #fff; appearance: none; }
            input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2); }
            .row { display: flex; gap: 12px; } .col { flex: 1; }

            table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
            th { background: #eee; padding: 10px; color: #444; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; text-align: center; }
            td { border-bottom: 1px solid #eee; padding: 8px; }
            tr:nth-child(even) { background-color: #fafafa; }
            .log-input { width: 100%; border: none; padding: 8px; text-align: center; background: transparent; font-weight: 500; }

            .btn { display: block; width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 700; text-align: center; }
            .btn:active { transform: scale(0.98); }
            .btn-gps { background: #e8f5e9; color: var(--primary); border: 1px solid var(--primary); display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
            .btn-outline { background: white; border: 2px solid var(--border); color: #555; }
            .btn-add { background: white; border: 2px dashed var(--primary); color: var(--primary); margin-top: 15px; }

            .timer-hero { background: #2d3436; color: white; border-radius: 12px; padding: 20px; text-align: center; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
            .timer-display { font-size: 2.5rem; font-family: monospace; font-weight: 700; letter-spacing: 2px; color: #00e676; }

            .help-btn { background: #e3f2fd; color: var(--blue); width: 24px; height: 24px; line-height: 24px; border-radius: 50%; display: inline-block; text-align: center; font-weight: bold; margin-left: 8px; cursor: pointer; }
            .tooltip-box { display: none; background: #fafafa; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-top: 10px; }
            .tooltip-box.active { display: block; }
            .diagram-container { text-align: center; margin: 10px 0; background: white; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; }
            svg { max-width: 100%; height: auto; }
            a.ref-link { color: var(--blue); text-decoration: none; font-weight: bold; }
            .sec-head { font-size: 0.9rem; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 5px; }

            .footer-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 12px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); display: flex; gap: 10px; z-index: 1000; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
            .footer-btn { flex: 1; padding: 12px; border-radius: 8px; border: none; font-size: 0.8rem; font-weight: 700; display: flex; flexDirection: column; align-items: center; justify-content: center; gap: 4px; }
            .fb-save { background: var(--primary); color: white; }
            .fb-dl { background: var(--blue); color: white; }
            .fb-pdf { background: #333; color: white; }
            .fb-new { background: #ffebee; color: var(--danger); max-width: 80px; }

            #print-container { display: none; }
            @keyframes fadeIn { from { opacity:0; transform: translateY(5px); } to { opacity:1; transform: translateY(0); } }
        }

        /* PRINT STYLES (Hidden on Screen, Visible on Print) */
        @media print {
            body { background: white; color: black; padding: 0; margin: 0; font-size: 12pt; }
            header, .footer-bar, .container, .tabs-wrapper { display: none !important; }
            
            #print-container { 
                display: block !important; 
                width: 100%; 
                margin: 0; padding: 20px;
            }
            
            .p-header { text-align: center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px; }
            .p-header h1 { margin: 0; font-size: 18pt; text-transform: uppercase; }
            .p-header p { margin: 0; font-size: 10pt; }

            .p-section { margin-bottom: 15px; border: 1px solid #999; padding: 10px; }
            .p-sec-title { background: #eee; font-weight: bold; padding: 5px; border-bottom: 1px solid #999; font-size: 11pt; margin: -10px -10px 10px -10px; text-transform: uppercase; }
            
            .p-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
            .p-row { display: flex; justify-content: space-between; border-bottom: 1px dotted #ccc; padding: 4px 0; }
            .p-label { font-weight: bold; font-size: 10pt; }
            .p-val { font-family: monospace; font-size: 11pt; }

            .p-table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-top: 5px; }
            .p-table th, .p-table td { border: 1px solid #000; padding: 4px; text-align: center; }
            .p-table th { background: #ddd; }
        }
    </style>
</head>
<body>

<header>
    <h1>Carnivore Pro v11</h1>
    <div class="subtitle">Ultimate Field Edition</div>
    <div id="saveStatus" style="font-size:0.7rem; margin-top:5px; opacity:0.8; display:none;">Auto-saved...</div>
</header>

<div class="container">
    <div class="tabs-wrapper">
        <div class="tab active" onclick="switchTab('tab-immob')">Capture</div>
        <div class="tab" onclick="switchTab('tab-calc')">Calculator</div>
        <div class="tab" onclick="switchTab('tab-morph')">Morphometry</div>
        <div class="tab" onclick="switchTab('tab-ref')">Ref & Links</div>
        <div class="tab" onclick="switchTab('tab-hist')">History</div>
    </div>

    <div id="tab-immob" class="tab-content active">
        <div class="card">
            <div class="sec-head">Identity & Location</div>
            <div class="row">
                <div class="col"><div class="form-group"><label>Date</label><input type="date" id="date" onchange="autoSave()"></div></div>
                <div class="col"><div class="form-group"><label>Time</label><input type="time" id="time" onchange="autoSave()"></div></div>
            </div>
            <button class="btn btn-gps" onclick="getGPS()"><span style="font-size:1.2rem;">üìç</span> <span id="gps_text">Get GPS Coordinates</span></button>
            <div class="row" style="margin-top:10px;">
                <div class="col"><input type="number" step="any" id="gps_n" placeholder="Lat (N)" oninput="autoSave()"></div>
                <div class="col"><input type="number" step="any" id="gps_e" placeholder="Long (E)" oninput="autoSave()"></div>
            </div>
            <div id="gps_status" style="font-size: 0.8rem; text-align: center; margin-top: 5px; color: #666;"></div>
            <div class="row" style="margin-top:15px;">
                <div class="col"><div class="form-group"><label>Species</label><select id="species" onchange="autoSave()"><option value="Tiger">Tiger</option><option value="Leopard">Leopard</option><option value="Sloth Bear">Sloth Bear</option><option value="Hyena">Hyena</option><option value="Wolf">Wolf</option></select></div></div>
                <div class="col"><div class="form-group"><label>ID / Name</label><input type="text" id="animal_id" placeholder="e.g. T-104" oninput="autoSave()"></div></div>
            </div>
        </div>

        <div class="card">
            <div class="sec-head">Capture Timeline</div>
            <div class="row">
                <div class="col"><label>Weight (Est)</label><input type="number" id="weight_est" oninput="autoSave()"></div>
                <div class="col"><label>Weight (Act)</label><input type="number" id="weight_act" oninput="autoSave()"></div>
            </div>
            <div class="timer-hero">
                <div style="font-size:0.8rem; color:#aaa; text-transform: uppercase;">Anesthesia Timer</div>
                <div id="timerDisplay" class="timer-display">00:00:00</div>
                <button class="btn btn-outline" style="background:transparent; color:white; border-color:#555; margin-top:10px;" onclick="toggleTimer()">Start / Stop</button>
            </div>
            <div class="row" style="margin-top:15px;">
                <div class="col"><label>Darted</label><input type="time" id="time_dart" onchange="autoSave()"></div>
                <div class="col"><label>Down</label><input type="time" id="time_down" onchange="autoSave()"></div>
            </div>
        </div>

        <div class="card card-warn">
            <div class="sec-head" style="color: var(--warn-text);">Supplemental / Top-Up Drugs</div>
            <table id="topupTable"><thead><tr><th width="70">Time</th><th>Drug</th><th width="60">mg</th><th width="60">Route</th></tr></thead><tbody></tbody></table>
            <button class="btn btn-add" style="border-color: #f57f17; color: #f57f17;" onclick="addTopupRow()">+ Add Top-Up Dose</button>
        </div>

        <div class="card">
            <div class="sec-head">Monitoring Log</div>
            <div style="overflow-x:auto;"><table id="logTable"><thead><tr><th width="60">Time</th><th width="50">HR</th><th width="50">RR</th><th width="50">SpO2</th><th>Note</th></tr></thead><tbody></tbody></table></div>
            <button class="btn btn-add" onclick="addLogStep()">+ Add 5-min Reading</button>
        </div>
        
        <div class="card">
            <div class="sec-head">Revival & Release</div>
            <div class="row">
                <div class="col"><div class="form-group"><label>Reversal Drug</label><input type="text" id="rev_drug" oninput="autoSave()"></div></div>
                <div class="col"><div class="form-group"><label>Route</label><select id="rev_route" onchange="autoSave()"><option>IM</option><option>IV</option></select></div></div>
            </div>
            <div class="row">
                <div class="col"><label>Given At</label><input type="time" id="time_rev" onchange="autoSave()"></div>
                <div class="col"><label>Head Up</label><input type="time" id="time_headup" onchange="autoSave()"></div>
                <div class="col"><label>Standing</label><input type="time" id="time_standing" onchange="autoSave()"></div>
            </div>
            <div class="form-group"><label>Release Site / Notes</label><input type="text" id="rel_notes" oninput="autoSave()"></div>
        </div>
    </div>

    <div id="tab-calc" class="tab-content">
        <div class="card">
            <div class="sec-head">Multi-Drug Calculator</div>
            <div class="form-group"><label>Animal Weight (kg)</label><input type="number" id="calc_weight" placeholder="Enter Weight" oninput="recalcAll()" style="font-size:1.2rem; padding:15px;"></div>
            <table class="calc-table" id="calcTable"><thead><tr><th>Drug</th><th>mg/kg</th><th>mg/ml</th><th>Vol</th><th></th></tr></thead><tbody></tbody></table>
            <button class="btn btn-add" onclick="addDrugRow()">+ Add Drug</button>
            <div id="resultBox" style="background:var(--primary); color:white; padding:20px; border-radius:8px; text-align:center; margin-top:20px; display:none;">
                <div style="font-size:0.8rem; opacity:0.8;">TOTAL VOLUME</div><div style="font-size:2rem; font-weight:bold;"><span id="total_vol_display">0.00</span> ml</div>
            </div>
        </div>
    </div>

    <div id="tab-morph" class="tab-content">
        <div class="card">
            <div class="sec-head">Measurements (cm)</div>
            <div class="form-group"><label>1. Total Body Length <span class="help-btn" onclick="toggleHelp('help_total')">?</span></label><input type="number" id="m_total_len" oninput="autoSave()">
                <div id="help_total" class="tooltip-box"><strong>Nose to Tail Tip</strong> (Over curves)<div class="diagram-container"><svg width="200" height="40" viewBox="0 0 200 40"><path d="M10,20 Q50,5 100,20 T190,20" fill="none" stroke="#2c7744" stroke-width="3"/><circle cx="10" cy="20" r="3" fill="#d63031"/><circle cx="190" cy="20" r="3" fill="#d63031"/></svg></div></div>
            </div>
            <div class="row"><div class="col"><div class="form-group"><label>2. Shoulder Ht</label><input type="number" id="m_shoulder" oninput="autoSave()"></div></div><div class="col"><div class="form-group"><label>3. Chest Girth</label><input type="number" id="m_chest" oninput="autoSave()"></div></div></div>
            <div class="form-group"><label>4. Neck Girth <span class="help-btn" onclick="toggleHelp('help_neck')">?</span></label><input type="number" id="m_neck" oninput="autoSave()">
                <div id="help_neck" class="tooltip-box">Collar fitting (narrowest part).<div class="diagram-container"><svg width="60" height="40" viewBox="0 0 60 40"><path d="M10,10 L50,10 L45,35 L15,35 Z" fill="#eee" stroke="#999"/><ellipse cx="30" cy="22" rx="12" ry="5" fill="none" stroke="#d63031" stroke-width="2" stroke-dasharray="3"/></svg></div></div>
            </div>
            <div class="form-group"><label>5. Head Circumference</label><input type="number" id="m_head_circ" oninput="autoSave()"></div>
            <label>Paw Width (cm)</label>
            <div class="row"><div class="col"><input type="number" id="m_paw_fore" placeholder="Fore" oninput="autoSave()"></div><div class="col"><input type="number" id="m_paw_hind" placeholder="Hind" oninput="autoSave()"></div></div>
        </div>
        <div class="card">
            <div class="sec-head">Dentition</div>
            <label>Upper Canines</label><div class="row"><div class="col"><input type="number" id="m_canine_ul" placeholder="Left" oninput="autoSave()"></div><div class="col"><input type="number" id="m_canine_ur" placeholder="Right" oninput="autoSave()"></div></div>
            <label style="margin-top:10px;">Lower Canines</label><div class="row"><div class="col"><input type="number" id="m_canine_ll" placeholder="Left" oninput="autoSave()"></div><div class="col"><input type="number" id="m_canine_lr" placeholder="Right" oninput="autoSave()"></div></div>
            <label style="margin-top:10px;">Inter-Canine Dist</label><div class="row"><div class="col"><input type="number" id="m_icd_up" placeholder="Upper" oninput="autoSave()"></div><div class="col"><input type="number" id="m_icd_low" placeholder="Lower" oninput="autoSave()"></div></div>
        </div>
    </div>

    <div id="tab-ref" class="tab-content">
        <div class="card">
            <div class="sec-head">Emergency Drugs</div>
            <p style="font-size:0.8rem;">Source: <a class="ref-link" href="https://wildtigerhealthproject.org/resources-category/anaesthetic-agents-and-associated-drugs/" target="_blank">Wild Tiger Health Project</a></p>
            <table><tr><th>Drug</th><th>Dose</th><th>Indication</th></tr><tr><td>Atropine</td><td>0.04 mg/kg</td><td>Bradycardia</td></tr><tr><td>Doxapram</td><td>1-2 mg/kg IV</td><td>Resp. Arrest</td></tr><tr><td>Diazepam</td><td>0.5 mg/kg</td><td>Seizures</td></tr><tr><td>Epinephrine</td><td>0.01 mg/kg</td><td>Cardiac Arrest</td></tr></table>
        </div>
        <div class="card"><div class="sec-head">Reversal Agents</div><table><tr><td>Atipamezole</td><td>5x Medetomidine dose</td></tr><tr><td>Yohimbine</td><td>0.125 mg/kg</td></tr></table></div>
    </div>

    <div id="tab-hist" class="tab-content">
        <div class="card"><div class="sec-head">Saved Records</div><div id="historyList"></div></div>
    </div>
</div>

<div class="footer-bar">
    <button class="footer-btn fb-save" onclick="saveToHistory()"><span>üíæ</span> SAVE</button>
    <button class="footer-btn fb-dl" onclick="exportCSV()"><span>‚¨áÔ∏è</span> CSV</button>
    <button class="footer-btn fb-pdf" onclick="printPDF()"><span>üìÑ</span> PDF</button>
    <button class="footer-btn fb-new" onclick="clearForm()"><span>üóëÔ∏è</span></button>
</div>

<div id="print-container"></div>

<script>
    // --- APP LOGIC ---
    function switchTab(t){
        document.querySelectorAll('.tab, .tab-content').forEach(e=>e.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        const map={'tab-immob':0,'tab-calc':1,'tab-morph':2,'tab-ref':3,'tab-hist':4};
        document.querySelectorAll('.tab')[map[t]].classList.add('active');
        window.scrollTo(0,0);
    }
    function toggleHelp(id) { document.getElementById(id).classList.toggle('active'); }
    function autoSave() { const s = document.getElementById('saveStatus'); s.style.display='block'; setTimeout(()=>s.style.display='none', 2000); }

    // GPS
    function getGPS() {
        const s = document.getElementById('gps_status'); const t = document.getElementById('gps_text');
        if(!navigator.geolocation) { s.innerText="No GPS support"; return;}
        s.innerText="Locating..."; t.innerText="Wait...";
        navigator.geolocation.getCurrentPosition(p=>{
            document.getElementById('gps_n').value = p.coords.latitude.toFixed(6);
            document.getElementById('gps_e').value = p.coords.longitude.toFixed(6);
            s.innerText = `Accuracy: ${p.coords.accuracy.toFixed(1)}m`; t.innerText="GPS Acquired"; s.style.color="green"; autoSave();
        }, e=>{ s.innerText="Error: "+e.message; t.innerText="Retry GPS"; s.style.color="red";}, {enableHighAccuracy:true, timeout:15000});
    }

    // LISTS
    const ids = ['date','time','gps_n','gps_e','species','animal_id','weight_est','weight_act','time_dart','time_down','rev_drug','rev_route','time_rev','time_headup','time_standing','rel_notes','m_total_len','m_shoulder','m_chest','m_neck','m_head_circ','m_paw_fore','m_paw_hind','m_canine_ul','m_canine_ur','m_canine_ll','m_canine_lr','m_icd_up','m_icd_low'];

    // TABLES
    function createRow(tableId, html) { const row = document.createElement('tr'); row.innerHTML=html; document.querySelector(`#${tableId} tbody`).appendChild(row); }
    function addLogStep(v=null) { const t = v?v[0]:new Date().toTimeString().substr(0,5); createRow('logTable', `<td><input type="time" class="log-input" value="${t}"></td><td><input type="number" class="log-input" value="${v?v[1]:''}"></td><td><input type="number" class="log-input" value="${v?v[2]:''}"></td><td><input type="number" class="log-input" value="${v?v[3]:''}"></td><td><input type="text" class="log-input" value="${v?v[4]:''}"></td>`); }
    function addTopupRow(v=null) { const t = v?v[0]:new Date().toTimeString().substr(0,5); const sel = v?v[3]:'IV'; createRow('topupTable', `<td><input type="time" class="log-input" value="${t}"></td><td><input type="text" class="log-input" placeholder="Drug" value="${v?v[1]:''}"></td><td><input type="number" class="log-input" placeholder="mg" value="${v?v[2]:''}"></td><td><select class="log-input"><option ${sel=='IV'?'selected':''}>IV</option><option ${sel=='IM'?'selected':''}>IM</option></select></td>`); }

    // CALCULATOR
    function addDrugRow(n="", d="", c="") { const id = 'r'+Date.now(); createRow('calcTable', `<td id="${id}"><input type="text" class="log-input" style="text-align:left;" placeholder="Drug" value="${n}"></td><td><input type="number" class="c-dose log-input" value="${d}" oninput="recalcAll()"></td><td><input type="number" class="c-conc log-input" value="${c}" oninput="recalcAll()"></td><td class="c-vol" style="font-weight:bold; color:var(--primary); text-align:center;">0.0</td><td onclick="document.getElementById('${id}').parentElement.remove(); recalcAll();" style="color:red; font-weight:bold; cursor:pointer;">X</td>`); }
    function recalcAll() { const wt = parseFloat(document.getElementById('calc_weight').value)||0; let tot=0; document.querySelectorAll('#calcTable tbody tr').forEach(r=>{ const d = parseFloat(r.querySelector('.c-dose').value)||0; const c = parseFloat(r.querySelector('.c-conc').value)||0; const v = (wt*d)/c; const cell = r.querySelector('.c-vol'); if(isFinite(v) && v>0) { cell.innerText=v.toFixed(2); tot+=v; } else { cell.innerText="0.0"; } }); document.getElementById('resultBox').style.display = tot>0?'block':'none'; document.getElementById('total_vol_display').innerText = tot.toFixed(2); }

    // HISTORY
    function saveToHistory() {
        const id = document.getElementById('animal_id').value || "Unknown";
        let rec = {id:id, date: document.getElementById('date').value, species: document.getElementById('species').value, logs:[], topups:[]};
        ids.forEach(k=>{ if(document.getElementById(k)) rec[k] = document.getElementById(k).value; });
        document.querySelectorAll('#logTable tbody tr').forEach(r=>{ let d=[]; r.querySelectorAll('input').forEach(i=>d.push(i.value)); rec.logs.push(d); });
        document.querySelectorAll('#topupTable tbody tr').forEach(r=>{ let d=[]; r.querySelectorAll('input, select').forEach(i=>d.push(i.value)); rec.topups.push(d); });
        let h = JSON.parse(localStorage.getItem('carnivore_db')||"[]").filter(x=>x.id!==id); h.unshift(rec); localStorage.setItem('carnivore_db', JSON.stringify(h)); alert("Saved to History!"); renderHistory();
    }
    
    function renderHistory() {
        const l = document.getElementById('historyList'); l.innerHTML=""; const h = JSON.parse(localStorage.getItem('carnivore_db')||"[]");
        if(h.length===0) l.innerHTML="<div style='text-align:center; padding:20px; color:#aaa;'>No records</div>";
        h.forEach((r,i)=>{ const d=document.createElement('div'); d.style.cssText="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;"; d.innerHTML = `<div><strong>${r.id}</strong> <span style="font-size:0.8rem; background:#eee; padding:2px 6px; border-radius:4px;">${r.species}</span><br><small style="color:#888">${r.date}</small></div><div><button class="btn-outline" style="display:inline; width:auto; padding:5px 10px; margin-right:5px;" onclick="loadRec(${i})">Load</button><button class="del-btn" style="color:red; background:#ffebee; border:none; padding:5px;" onclick="delRec(${i})">X</button></div>`; l.appendChild(d); });
    }
    
    function loadRec(i) {
        const r = JSON.parse(localStorage.getItem('carnivore_db'))[i]; ids.forEach(k=>{ if(document.getElementById(k)) document.getElementById(k).value=r[k]||""; });
        document.querySelector('#logTable tbody').innerHTML=""; r.logs.forEach(l=>addLogStep(l)); document.querySelector('#topupTable tbody').innerHTML=""; r.topups.forEach(l=>addTopupRow(l)); switchTab('tab-immob');
    }
    
    function delRec(i) { if(!confirm("Delete?")) return; let h = JSON.parse(localStorage.getItem('carnivore_db')); h.splice(i,1); localStorage.setItem('carnivore_db', JSON.stringify(h)); renderHistory(); }

    function exportCSV() {
        let c = "Field,Value\n"; ids.forEach(k=>{ const el=document.getElementById(k); if(el) c+=`${k},${el.value}\n`; });
        c+="\nMONITORING LOGS\nTime,HR,RR,SpO2,Note\n"; document.querySelectorAll('#logTable tbody tr').forEach(r=>{ let l=[]; r.querySelectorAll('input').forEach(i=>l.push(i.value)); c+=l.join(',')+"\n"; });
        c+="\nTOP-UP DOSES\nTime,Drug,mg,Route\n"; document.querySelectorAll('#topupTable tbody tr').forEach(r=>{ let l=[]; r.querySelectorAll('input, select').forEach(i=>l.push(i.value)); c+=l.join(',')+"\n"; });
        const b = new Blob([c],{type:'text/csv'}); const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download=(document.getElementById('animal_id').value||"data")+".csv"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    
    function clearForm() {
        if(confirm("Clear Form?")) { document.querySelectorAll('input').forEach(i=>i.value=""); document.querySelector('#logTable tbody').innerHTML=""; document.querySelector('#topupTable tbody').innerHTML=""; document.getElementById('date').valueAsDate = new Date(); addLogStep(); addDrugRow('Ketamine','4','100'); addDrugRow('Xylazine','1','100'); }
    }

    // PRINT PDF ENGINE
    function val(id) { const el = document.getElementById(id); return el ? el.value : ''; }
    function printPDF() {
        const c = document.getElementById('print-container');
        let html = `
            <div class="p-header"><h1>Carnivore Datasheet</h1><p>Generated: ${new Date().toLocaleString()}</p></div>
            
            <div class="p-section"><div class="p-sec-title">I. Identity</div>
            <div class="p-grid"><div class="p-row"><span class="p-label">ID:</span> <span class="p-val">${val('animal_id')}</span></div><div class="p-row"><span class="p-label">Species:</span> <span class="p-val">${val('species')}</span></div></div>
            <div class="p-grid"><div class="p-row"><span class="p-label">Date:</span> <span class="p-val">${val('date')}</span></div><div class="p-row"><span class="p-label">Sex:</span> <span class="p-val">${val('sex')}</span></div></div>
            <div class="p-grid"><div class="p-row"><span class="p-label">Lat:</span> <span class="p-val">${val('gps_n')}</span></div><div class="p-row"><span class="p-label">Long:</span> <span class="p-val">${val('gps_e')}</span></div></div>
            </div>

            <div class="p-section"><div class="p-sec-title">II. Vitals & Timeline</div>
            <div class="p-grid"><div class="p-row"><span class="p-label">Wt (Act):</span> <span class="p-val">${val('weight_act')}</span></div><div class="p-row"><span class="p-label">Wt (Est):</span> <span class="p-val">${val('weight_est')}</span></div></div>
            <div class="p-grid"><div class="p-row"><span class="p-label">Darted:</span> <span class="p-val">${val('time_dart')}</span></div><div class="p-row"><span class="p-label">Down:</span> <span class="p-val">${val('time_down')}</span></div></div>
            </div>

            <div class="p-section"><div class="p-sec-title">III. Monitoring Log</div>
            <table class="p-table"><thead><tr><th>Time</th><th>HR</th><th>RR</th><th>SpO2</th><th>Notes</th></tr></thead><tbody>`;
            
        document.querySelectorAll('#logTable tbody tr').forEach(r=>{
            let d=[]; r.querySelectorAll('input').forEach(i=>d.push(i.value));
            if(d[0]) html+=`<tr><td>${d[0]}</td><td>${d[1]}</td><td>${d[2]}</td><td>${d[3]}</td><td>${d[4]}</td></tr>`;
        });
        html+=`</tbody></table></div>
        
        <div class="p-section"><div class="p-sec-title">IV. Top-Ups</div>
        <table class="p-table"><thead><tr><th>Time</th><th>Drug</th><th>mg</th><th>Route</th></tr></thead><tbody>`;
        document.querySelectorAll('#topupTable tbody tr').forEach(r=>{
            let d=[]; r.querySelectorAll('input, select').forEach(i=>d.push(i.value));
            if(d[0]) html+=`<tr><td>${d[0]}</td><td>${d[1]}</td><td>${d[2]}</td><td>${d[3]}</td></tr>`;
        });
        html+=`</tbody></table></div>

        <div class="p-section"><div class="p-sec-title">V. Morphometry</div>
        <div class="p-grid"><div class="p-row"><span class="p-label">Total Len:</span> <span class="p-val">${val('m_total_len')}</span></div><div class="p-row"><span class="p-label">Shoulder:</span> <span class="p-val">${val('m_shoulder')}</span></div></div>
        <div class="p-grid"><div class="p-row"><span class="p-label">Chest:</span> <span class="p-val">${val('m_chest')}</span></div><div class="p-row"><span class="p-label">Neck:</span> <span class="p-val">${val('m_neck')}</span></div></div>
        <div class="p-grid"><div class="p-row"><span class="p-label">Up Canine (L/R):</span> <span class="p-val">${val('m_canine_ul')} / ${val('m_canine_ur')}</span></div><div class="p-row"><span class="p-label">Low Canine (L/R):</span> <span class="p-val">${val('m_canine_ll')} / ${val('m_canine_lr')}</span></div></div>
        </div>

        <div class="p-section"><div class="p-sec-title">VI. Revival</div>
        <div class="p-grid"><div class="p-row"><span class="p-label">Drug:</span> <span class="p-val">${val('rev_drug')}</span></div><div class="p-row"><span class="p-label">Given:</span> <span class="p-val">${val('time_rev')}</span></div></div>
        <div class="p-grid"><div class="p-row"><span class="p-label">Head Up:</span> <span class="p-val">${val('time_headup')}</span></div><div class="p-row"><span class="p-label">Standing:</span> <span class="p-val">${val('time_standing')}</span></div></div>
        </div>`;
        
        c.innerHTML = html;
        window.print();
    }

    // TIMER
    let ti, s=0, run=false;
    function toggleTimer(){
        if(run){ clearInterval(ti); run=false; }
        else { run=true; ti=setInterval(()=>{ s++; let h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60; document.getElementById('timerDisplay').innerText=`${h<10?'0'+h:h}:${m<10?'0'+m:m}:${sec<10?'0'+sec:sec}`; },1000); }
    }

    // INIT
    document.getElementById('date').valueAsDate = new Date();
    addLogStep();
    addDrugRow('Ketamine','4','100'); addDrugRow('Xylazine','1','100');
    renderHistory();
</script>
</body>
</html>
```